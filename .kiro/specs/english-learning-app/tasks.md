# 実装計画

- [x] 1. プロジェクト初期設定とインフラストラクチャ構築
  - Cloudflare Workersプロジェクトの初期化（Wrangler）
  - 必要な依存関係のインストール（Hono、Drizzle ORM、React、Chakra UI、TanStack Query等）
  - TypeScript設定ファイルの作成
  - プロジェクトディレクトリ構造の構築
  - _要件: すべての要件の基盤_

- [x] 1.1 Cloudflare D1データベースのセットアップ
  - D1データベースの作成
  - Drizzle ORMスキーマ定義（users、contentsテーブル）
  - マイグレーションファイルの生成と実行
  - _要件: 1.5, 3.1, 3.2, 4.2_

- [x] 1.2 Cloudflare KVネームスペースの作成
  - セッション管理用KVネームスペースの作成
  - Wrangler設定ファイルへのバインディング追加
  - _要件: 4.2, 4.5, 4.6_

- [x] 1.3 開発環境のセットアップ
  - ローカル開発サーバーの設定
  - 環境変数の設定（.dev.vars）
  - _要件: すべての要件_

- [ ] 2. 認証システムの実装
  - GitHub OAuth認証フローの実装
  - セッション管理機能の実装（Cloudflare KV使用）
  - 認証ミドルウェアの作成
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ] 2.1 GitHub OAuth認証エンドポイントの実装
  - `/auth/github` エンドポイント（OAuth開始）
  - `/auth/github/callback` エンドポイント（コールバック処理）
  - GitHubユーザー情報の取得とDB保存
  - _要件: 4.2, 4.3_

- [ ] 2.2 プロパティテスト: セッション有効性の維持
  - **Property 12: セッション有効性の維持**
  - **検証対象: 要件 4.6**

- [ ] 2.3 セッション管理機能の実装
  - セッション作成関数（KVへの保存、TTL設定）
  - セッション検証関数（KVからの取得）
  - セッション削除関数（ログアウト）
  - _要件: 4.5, 4.6_

- [ ] 2.4 認証ミドルウェアの実装
  - リクエストからセッションIDを取得
  - KVでセッション検証
  - 未認証時のリダイレクト処理
  - _要件: 4.1, 3.4_

- [ ] 2.5 プロパティテスト: 認証済みユーザーのみのアクセス
  - **Property 11: 認証済みユーザーのみのアクセス**
  - **検証対象: 要件 3.4, 4.1**

- [ ] 3. 記事取得機能の実装
  - URL検証機能の実装
  - 記事スクレイピング機能の実装
  - HTMLパーサーの実装
  - _要件: 1.1, 5.1, 5.2, 5.3_

- [ ] 3.1 URL検証関数の実装
  - URL形式の検証（正規表現）
  - プロトコルチェック（http/https）
  - _要件: 5.1_

- [ ] 3.2 プロパティテスト: エラー入力の拒否
  - **Property 5: エラー入力の拒否**
  - **検証対象: 要件 5.1, 5.2**

- [ ] 3.3 記事スクレイピング機能の実装
  - HTTPリクエストの送信
  - HTMLの取得
  - タイムアウト処理
  - エラーハンドリング（404、403、ネットワークエラー）
  - _要件: 1.1, 5.2, 5.3_

- [ ] 3.4 プロパティテスト: 記事取得の成功
  - **Property 1: 記事取得の成功**
  - **検証対象: 要件 1.1**

- [ ] 3.5 HTMLパーサーの実装
  - タイトル抽出
  - 本文抽出（メインコンテンツの識別）
  - 不要な要素の除去（広告、ナビゲーション等）
  - _要件: 1.1_

- [ ] 4. OpenAI API統合とコンテンツ生成機能
  - OpenAI APIクライアントの設定
  - 日本語要約生成機能
  - 英単語抽出・翻訳機能
  - Q&A生成機能
  - _要件: 1.2, 1.3, 1.4, 6.1, 6.2, 7.1, 7.2_

- [ ] 4.1 OpenAI APIクライアントのセットアップ
  - OpenAI SDK for JavaScriptの設定
  - APIキーの環境変数管理
  - エラーハンドリング（レート制限、トークン制限等）
  - _要件: 1.2, 1.3, 1.4_

- [ ] 4.2 日本語要約生成機能の実装
  - プロンプトの設計
  - OpenAI APIの呼び出し
  - レスポンスのパース
  - _要件: 1.2_

- [ ] 4.3 プロパティテスト: 日本語要約の生成
  - **Property 3: 日本語要約の生成**
  - **検証対象: 要件 1.2**

- [ ] 4.4 英単語抽出・翻訳機能の実装
  - CEFR B1以上の単語抽出プロンプトの設計
  - OpenAI APIの呼び出し
  - 単語リストのパース（単語、翻訳、難易度、文脈）
  - _要件: 1.3, 6.1, 6.2_

- [ ] 4.5 プロパティテスト: 高校レベル以上の英単語抽出
  - **Property 4: 高校レベル以上の英単語抽出**
  - **検証対象: 要件 1.3, 6.1**

- [ ] 4.6 単語リストソート機能の実装
  - 出現順ソート
  - 難易度順ソート
  - _要件: 6.4_

- [ ] 4.7 プロパティテスト: 単語リストのソート順
  - **Property 10: 単語リストのソート順**
  - **検証対象: 要件 6.4**

- [ ] 4.8 Q&A生成機能の実装
  - 3〜5個の質問生成プロンプトの設計
  - 選択肢・記述式の両方に対応
  - 正解と解説の生成
  - _要件: 1.4, 7.1, 7.2_

- [ ] 4.9 プロパティテスト: Q&A生成の完全性
  - **Property 9: Q&A生成の完全性**
  - **検証対象: 要件 7.1, 7.2**

- [ ] 5. 回答評価機能の実装（OpenAI API使用）
  - ユーザー回答の動的評価機能
  - 記述式回答の柔軟な判定
  - フィードバック生成
  - _要件: 7.3_

- [ ] 5.1 回答評価APIエンドポイントの実装
  - `/api/evaluate` エンドポイント
  - リクエストボディの検証（質問、回答、記事コンテキスト）
  - OpenAI APIを使用した評価プロンプトの設計
  - 正誤判定、フィードバック、判定理由の生成
  - _要件: 7.3_

- [ ] 5.2 プロパティテスト: OpenAI APIによる動的回答評価
  - **Property 14: OpenAI APIによる動的回答評価**
  - **検証対象: 要件 7.3**

- [ ] 6. コンテンツ管理機能の実装
  - コンテンツ保存機能（D1）
  - コンテンツ取得機能（UUID）
  - UUID生成機能
  - _要件: 1.5, 3.1, 3.2, 3.3, 5.4_

- [ ] 6.1 UUID生成とコンテンツ保存機能の実装
  - UUID v4の生成
  - D1へのコンテンツ保存（トランザクション使用）
  - エラー時のロールバック
  - _要件: 1.5, 3.1, 5.4_

- [ ] 6.2 プロパティテスト: UUID一意性
  - **Property 6: UUID一意性**
  - **検証対象: 要件 3.1**

- [ ] 6.3 プロパティテスト: トランザクション整合性
  - **Property 13: トランザクション整合性**
  - **検証対象: 要件 5.4**

- [ ] 6.4 コンテンツ取得機能の実装
  - UUIDによるコンテンツ検索
  - 存在しないUUIDのエラー処理
  - JSONデータのパース（vocabulary、questions）
  - _要件: 3.2, 3.3_

- [ ] 6.5 プロパティテスト: コンテンツ保存と取得のラウンドトリップ
  - **Property 7: コンテンツ保存と取得のラウンドトリップ**
  - **検証対象: 要件 3.2**

- [ ] 6.6 プロパティテスト: 存在しないUUIDのエラー処理
  - **Property 8: 存在しないUUIDのエラー処理**
  - **検証対象: 要件 3.3**

- [ ] 7. APIエンドポイントの実装（Hono）
  - コンテンツ生成エンドポイント
  - コンテンツ取得エンドポイント
  - 認証エンドポイント
  - _要件: すべての要件_

- [ ] 7.1 コンテンツ生成APIエンドポイントの実装
  - `POST /api/content` エンドポイント
  - リクエストボディの検証（URL）
  - 記事取得 → コンテンツ生成 → 保存の統合フロー
  - UUIDの返却
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 7.2 コンテンツ取得APIエンドポイントの実装
  - `GET /api/content/:uuid` エンドポイント
  - 認証チェック
  - コンテンツの取得と返却
  - _要件: 3.2, 3.3, 3.4_

- [ ] 7.3 ユーザーコンテンツ一覧APIエンドポイントの実装
  - `GET /api/user/contents` エンドポイント
  - 認証チェック
  - ユーザーIDでコンテンツをフィルタリング
  - _要件: 該当なし（将来の拡張）_

- [ ] 8. フロントエンド実装（React + Chakra UI + TanStack Query）
  - ログイン画面
  - URL入力画面
  - コンテンツ表示画面
  - ローディング・エラー状態の表示
  - _要件: 2.1, 2.2, 2.3, 4.1_

- [ ] 8.1 プロジェクト構造とルーティングの設定
  - Reactアプリケーションの初期化
  - ルーティング設定（React Router）
  - Chakra UIプロバイダーの設定
  - TanStack Queryプロバイダーの設定
  - _要件: すべての要件_

- [ ] 8.2 ログイン画面の実装
  - GitHub認証ボタン
  - 認証フローの開始
  - _要件: 4.1, 4.2_

- [ ] 8.3 URL入力画面の実装
  - URL入力フォーム（Chakra UI Input）
  - クライアント側バリデーション
  - 送信ボタン
  - TanStack Queryでコンテンツ生成APIを呼び出し
  - ローディング状態の表示
  - _要件: 1.1, 5.1_

- [ ] 8.4 コンテンツ表示画面の実装
  - 日本語要約セクション
  - 英単語訳セクション
  - Q&Aセクション
  - 元記事URLリンク
  - レスポンシブレイアウト（Chakra UI）
  - _要件: 2.1, 2.2, 2.3_

- [ ] 8.5 プロパティテスト: コンテンツ表示の完全性
  - **Property 2: コンテンツ表示の完全性**
  - **検証対象: 要件 2.1, 2.2**

- [ ] 8.6 Q&A回答機能の実装
  - 選択肢型質問のUI
  - 記述式質問のUI
  - 回答送信ボタン
  - TanStack Queryで回答評価APIを呼び出し
  - フィードバック表示
  - _要件: 7.3_

- [ ] 8.7 エラーハンドリングUIの実装
  - エラーメッセージの表示（Chakra UI Toast）
  - 再試行ボタン
  - _要件: 5.1, 5.2, 5.3_

- [ ] 9. レート制限とセキュリティ機能の実装
  - Cloudflare KVを使用したレート制限
  - CSRF保護
  - 入力サニタイゼーション
  - _要件: すべての要件（セキュリティ）_

- [ ] 9.1 レート制限ミドルウェアの実装
  - KVでリクエストカウンターを管理
  - ユーザーごとの制限（TTL付き）
  - レート制限超過時のエラーレスポンス
  - _要件: すべての要件（悪用防止）_

- [ ] 9.2 CSRF保護の実装
  - CSRFトークンの生成と検証
  - セッションとの紐付け
  - _要件: 4.1, 4.2_

- [ ] 10. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストを実行し、パスすることを確認
  - 問題が発生した場合はユーザーに質問する
  - _要件: すべての要件_

- [ ] 11. デプロイとCI/CD設定
  - Wranglerを使用したCloudflare Workersへのデプロイ
  - GitHub Actionsワークフローの作成
  - 環境変数の設定（Wrangler Secrets）
  - _要件: すべての要件_

- [ ] 11.1 本番環境へのデプロイ設定
  - Wrangler設定ファイルの本番環境設定
  - D1とKVのバインディング設定
  - カスタムドメインの設定（オプション）
  - _要件: すべての要件_

- [ ] 11.2 GitHub Actionsワークフローの作成
  - テスト実行ステップ
  - ビルドステップ
  - デプロイステップ（Wrangler）
  - _要件: すべての要件_

- [ ] 11.3 環境変数とシークレットの設定
  - OpenAI APIキーの設定（Wrangler Secrets）
  - GitHub OAuth認証情報の設定
  - その他の環境変数
  - _要件: すべての要件_

- [ ] 12. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストを実行し、パスすることを確認
  - 本番環境での動作確認
  - 問題が発生した場合はユーザーに質問する
  - _要件: すべての要件_
